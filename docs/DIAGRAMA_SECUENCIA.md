# Diagrama de Secuencia - Sistema de VerificaciÃ³n de Email

## Flujo Completo de Registro y VerificaciÃ³n

```
USUARIO          FRONTEND              BACKEND              BD
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  1. Completa     â”‚                    â”‚                â”‚
   â”‚  formulario      â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                 â”‚  2. POST /register â”‚                â”‚
   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                 â”‚                    â”‚ 3. Validar     â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚ (email unique)  â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 4. Hash pwd     â”‚
   â”‚                 â”‚                    â”‚ 5. Crear user   â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚ (id=1)          â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 6. Gen cÃ³digo   â”‚
   â”‚                 â”‚                    â”‚ (4 dÃ­gitos)     â”‚
   â”‚                 â”‚                    â”‚ 7. Expira +15m  â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚ EmailVerif.     â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 8. Enviar email â”‚
   â”‚                 â”‚  9. {msg, email}   â”‚    (consola)    â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  10. Ver email  â”‚                    â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—
   â”‚ Usuario recibe correo con cÃ³digo (ej: 4892)         â”‚
   â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  11. Ingresa    â”‚                    â”‚                â”‚
   â”‚  cÃ³digo        â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                 â”‚  12. POST /verify- â”‚                â”‚
   â”‚                 â”‚  email             â”‚                â”‚
   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                 â”‚                    â”‚ 13. Buscar     â”‚
   â”‚                 â”‚                    â”‚ verificacion   â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚ (pending)       â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 14. Validar:   â”‚
   â”‚                 â”‚                    â”‚ - No expirado   â”‚
   â”‚                 â”‚                    â”‚ - Intentos OK   â”‚
   â”‚                 â”‚                    â”‚ - CÃ³digo ==     â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚ 15. Respuesta OK   â”‚ 16. Marcar      â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ usado           â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚  16. âœ“          â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚  Verificado     â”‚                    â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚ 17. Update      â”‚
   â”‚                 â”‚                    â”‚ isEmailVerif    â”‚
   â”‚                 â”‚                    â”‚ = true          â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  18. Ir a login â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  19. Ingresa    â”‚                    â”‚                â”‚
   â”‚  credenciales   â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                 â”‚  20. POST /login   â”‚                â”‚
   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                 â”‚                    â”‚ 21. Validar    â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚ (isEmailVerif   â”‚
   â”‚                 â”‚                    â”‚  = true)        â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 22. Gen JWT     â”‚
   â”‚                 â”‚                    â”‚ 24h exp         â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  23. JWT Token  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  ðŸ” LOGUEADO   â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
```

## Flujo de Error - CÃ³digo Incorrecto

```
USUARIO          FRONTEND              BACKEND              BD
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  1. Ingresa     â”‚                    â”‚                â”‚
   â”‚  cÃ³digo errado  â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                 â”‚  2. POST /verify   â”‚                â”‚
   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                 â”‚                    â”‚ 3. Buscar      â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚ (pending)       â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 4. Validar      â”‚
   â”‚                 â”‚                    â”‚ - No expirado âœ“â”‚
   â”‚                 â”‚                    â”‚ - Intentos<3 âœ“ â”‚
   â”‚                 â”‚                    â”‚ - CÃ³digo â‰  âœ—   â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 5. Incrementar  â”‚
   â”‚                 â”‚                    â”‚ intentos (1/3)  â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚  6. 400 Bad Requestâ”‚                â”‚
   â”‚                 â”‚  "CÃ³digo incorrectoâ”‚                â”‚
   â”‚                 â”‚   2 intentos left" â”‚                â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  7. âœ— Error     â”‚                    â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  8. Intenta     â”‚                    â”‚                â”‚
   â”‚  de nuevo       â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  (repite ciclo)    â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚ (Si 3 intentos  â”‚                    â”‚                â”‚
   â”‚  fallidos)      â”‚                    â”‚                â”‚
   â”‚                 â”‚  "Max intentos     â”‚                â”‚
   â”‚                 â”‚   Solicitar nuevo" â”‚                â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
```

## Flujo de ReenvÃ­o de CÃ³digo

```
USUARIO          FRONTEND              BACKEND              BD
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  1. "Reenviar   â”‚                    â”‚                â”‚
   â”‚  cÃ³digo"        â”‚                    â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                 â”‚  2. POST /resend   â”‚                â”‚
   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                 â”‚                    â”‚ 3. Buscar      â”‚
   â”‚                 â”‚                    â”‚ cÃ³digos pending â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 4. Marcar      â”‚
   â”‚                 â”‚                    â”‚ antiguos como   â”‚
   â”‚                 â”‚                    â”‚ isUsed = true   â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 5. Generar     â”‚
   â”‚                 â”‚                    â”‚ nuevo cÃ³digo    â”‚
   â”‚                 â”‚                    â”‚ 6. Expira +15m  â”‚
   â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚                 â”‚                    â”‚ 7. Enviar      â”‚
   â”‚                 â”‚                    â”‚ correo (console)â”‚
   â”‚                 â”‚  8. {msg, email}   â”‚                â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚                 â”‚                    â”‚                â”‚
   â”‚  âœ“ Nuevo cÃ³digo â”‚                    â”‚                â”‚
   â”‚  enviado        â”‚                    â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                â”‚
```

## Estados de la Tabla EmailVerification

```
ESTADO INICIAL (DespuÃ©s del registro)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id: 1                                       â”‚
â”‚ userId: 1                                   â”‚
â”‚ code: "4892"                                â”‚
â”‚ attempts: 0                    â† Sin intentosâ”‚
â”‚ maxAttempts: 3                              â”‚
â”‚ expiresAt: 2025-12-18 10:47:30 â† +15 min   â”‚
â”‚ isUsed: false                 â† Pendiente    â”‚
â”‚ usedAt: null                                â”‚
â”‚ createdAt: 2025-12-18 10:32:30              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DESPUÃ‰S DE 1 INTENTO FALLIDO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id: 1                                       â”‚
â”‚ userId: 1                                   â”‚
â”‚ code: "4892"                                â”‚
â”‚ attempts: 1                    â† Incrementadoâ”‚
â”‚ maxAttempts: 3                              â”‚
â”‚ expiresAt: 2025-12-18 10:47:30              â”‚
â”‚ isUsed: false                               â”‚
â”‚ usedAt: null                                â”‚
â”‚ createdAt: 2025-12-18 10:32:30              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DESPUÃ‰S DE VERIFICACIÃ“N EXITOSA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id: 1                                       â”‚
â”‚ userId: 1                                   â”‚
â”‚ code: "4892"                                â”‚
â”‚ attempts: 1                                 â”‚
â”‚ maxAttempts: 3                              â”‚
â”‚ expiresAt: 2025-12-18 10:47:30              â”‚
â”‚ isUsed: true                   â† Marcado    â”‚
â”‚ usedAt: 2025-12-18 10:35:15    â† Timestamp  â”‚
â”‚ createdAt: 2025-12-18 10:32:30              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DESPUÃ‰S DE REENVÃO (CÃ³digo Anterior)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id: 1                                       â”‚
â”‚ userId: 1                                   â”‚
â”‚ code: "4892"                                â”‚
â”‚ attempts: 0                                 â”‚
â”‚ maxAttempts: 3                              â”‚
â”‚ expiresAt: 2025-12-18 10:47:30              â”‚
â”‚ isUsed: true                   â† Marcado    â”‚
â”‚ usedAt: 2025-12-18 10:35:15                 â”‚
â”‚ createdAt: 2025-12-18 10:32:30              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DESPUÃ‰S DE REENVÃO (CÃ³digo Nuevo)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id: 2                                       â”‚
â”‚ userId: 1                                   â”‚
â”‚ code: "7531"                   â† Nuevo      â”‚
â”‚ attempts: 0                                 â”‚
â”‚ maxAttempts: 3                              â”‚
â”‚ expiresAt: 2025-12-18 10:50:45 â† +15 min    â”‚
â”‚ isUsed: false                  â† Pendiente   â”‚
â”‚ usedAt: null                                â”‚
â”‚ createdAt: 2025-12-18 10:35:45              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Tabla de Tiempos

| AcciÃ³n | Tiempo |
|--------|--------|
| CÃ³digo generado | T+0 |
| VÃ¡lido hasta | T+15 minutos |
| MÃ¡ximo de intentos | 3 |
| Incremento por intento fallido | InstantÃ¡neo |
| JWT vÃ¡lido | 24 horas |
| ExpiraciÃ³n de cookie de sesiÃ³n | Browser dependent |

---

Generado: 18 de Diciembre de 2025
